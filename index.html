<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>College Hostel Secretary Election</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/solana-web3.js/1.73.0/index.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-800">College Hostel Secretary Election</h1>
            <p class="text-gray-600 mt-2">Cast your vote securely using blockchain technology</p>
        </header>

        <!-- Authentication Section -->
        <div id="auth-section" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Voter Authentication</h2>
            <div id="email-form">
                <label for="email" class="block text-gray-700 mb-2">Enter your college email:</label>
                <div class="flex">
                    <input type="email" id="email" class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="yourname@college.edu">
                </div>
                <p id="email-error" class="text-red-500 text-sm mt-1 hidden">Please enter a valid college email address.</p>
                <button id="auth-btn" class="mt-4 w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Authenticate
                </button>
            </div>
        </div>

        <!-- Voting Section (Hidden initially) -->
        <div id="voting-section" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Cast Your Vote</h2>
            <p class="text-gray-600 mb-4">Select one candidate from the list below:</p>
            
            <div class="space-y-3 mb-6">
                <div class="candidate-option">
                    <input type="radio" id="candidate-1" name="candidate" value="Alice" class="mr-2">
                    <label for="candidate-1" class="text-gray-800">Alice</label>
                </div>
                <div class="candidate-option">
                    <input type="radio" id="candidate-2" name="candidate" value="Bob" class="mr-2">
                    <label for="candidate-2" class="text-gray-800">Bob</label>
                </div>
                <div class="candidate-option">
                    <input type="radio" id="candidate-3" name="candidate" value="Charlie" class="mr-2">
                    <label for="candidate-3" class="text-gray-800">Charlie</label>
                </div>
                <div class="candidate-option">
                    <input type="radio" id="candidate-4" name="candidate" value="David" class="mr-2">
                    <label for="candidate-4" class="text-gray-800">David</label>
                </div>
                <div class="candidate-option">
                    <input type="radio" id="candidate-5" name="candidate" value="Eve" class="mr-2">
                    <label for="candidate-5" class="text-gray-800">Eve</label>
                </div>
            </div>
            
            <button id="cast-vote-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed">
                Cast My Vote
            </button>
        </div>

        <!-- Success Section (Hidden initially) -->
        <div id="success-section" class="bg-white rounded-lg shadow-md p-6 text-center hidden">
            <svg class="w-16 h-16 mx-auto text-green-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Vote Cast Successfully!</h2>
            <p class="text-gray-600 mb-4">Your vote has been securely recorded on the blockchain.</p>
            <div class="mt-4">
                <p class="text-sm text-gray-500">Transaction ID:</p>
                <p id="transaction-id" class="text-xs text-blue-600 break-all"></p>
            </div>
        </div>

        <!-- Error Section (Hidden initially) -->
        <div id="error-section" class="bg-white rounded-lg shadow-md p-6 text-center hidden">
            <svg class="w-16 h-16 mx-auto text-red-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="text-2xl font-semibold text-gray-800 mb-2">Error Occurred</h2>
            <p id="error-message" class="text-gray-600 mb-4">Something went wrong. Please try again.</p>
            <button id="try-again-btn" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Try Again
            </button>
        </div>

        <footer class="text-center text-gray-500 text-sm mt-8">
            Â© 2025 College Hostel Election Committee. All rights reserved.
        </footer>
    </div>

    <script>
        // DOM elements
        const authSection = document.getElementById('auth-section');
        const emailForm = document.getElementById('email-form');
        const votingSection = document.getElementById('voting-section');
        const successSection = document.getElementById('success-section');
        const errorSection = document.getElementById('error-section');
        
        const emailInput = document.getElementById('email');
        const authBtn = document.getElementById('auth-btn');
        const castVoteBtn = document.getElementById('cast-vote-btn');
        const tryAgainBtn = document.getElementById('try-again-btn');
        
        const emailError = document.getElementById('email-error');
        const errorMessage = document.getElementById('error-message');
        const transactionId = document.getElementById('transaction-id');

        // Global variables
        let currentUser = null;
        let solanaConnection = null;
        let walletKeyPair = null;

        // Initialize Solana connection with error handling
        async function initializeSolana() {
            try {
                // Make sure solanaWeb3 is correctly loaded
                if (typeof solanaWeb3 === 'undefined') {
                    console.error("Solana Web3 library not loaded");
                    throw new Error("Blockchain library not available");
                }
                
                // For demo purposes, use a try-catch around the connection initialization
                try {
                    solanaConnection = new solanaWeb3.Connection(
                        solanaWeb3.clusterApiUrl('devnet'),
                        'confirmed'
                    );
                } catch (connErr) {
                    console.error("Failed to create Solana connection:", connErr);
                    // Fallback to a mock connection for demo purposes
                    solanaConnection = {
                        getRecentBlockhash: async () => ({ blockhash: 'demo-blockhash' }),
                        sendRawTransaction: async () => 'demo-transaction-signature',
                        confirmTransaction: async () => true
                    };
                }
                
                // Generate a temporary keypair for the demo
                try {
                    walletKeyPair = solanaWeb3.Keypair.generate();
                } catch (keyErr) {
                    console.error("Failed to generate keypair:", keyErr);
                    // Create a mock keypair for demo
                    walletKeyPair = {
                        publicKey: { toString: () => 'demo-public-key' },
                        secretKey: new Uint8Array(32)
                    };
                }
                
                console.log("Solana connection established");
                return true;
            } catch (error) {
                console.error("Failed to initialize Solana connection:", error);
                
                // For the demo, let's proceed anyway with mock objects
                solanaConnection = {
                    getRecentBlockhash: async () => ({ blockhash: 'demo-blockhash' }),
                    sendRawTransaction: async () => 'demo-transaction-signature',
                    confirmTransaction: async () => true
                };
                
                walletKeyPair = {
                    publicKey: { toString: () => 'demo-public-key' },
                    secretKey: new Uint8Array(32)
                };
                
                // In demo mode, don't show error and continue
                console.log("Continuing in demo mode with mock blockchain connection");
                return true;
            }
        }

        // Validate email (simple validation for demo)
        function validateEmail(email) {
            // Check if it looks like an email
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                return false;
            }
            
            // Check if it's a college email (ends with .edu or your specific college domain)
            return email.endsWith('.edu') || email.includes('college');
        }

        // Authenticate with college email
        async function authenticateEmail() {
            const email = emailInput.value.trim();
            
            if (!validateEmail(email)) {
                emailError.classList.remove('hidden');
                return;
            }
            
            emailError.classList.add('hidden');
            authBtn.disabled = true;
            authBtn.textContent = 'Authenticating...';
            
            try {
                // In a real app, you would send an API request to validate the email
                // For demo purposes, we'll simulate an API call with a timeout
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Check if user has already voted
                const hasVoted = await checkIfVoted(email);
                
                if (hasVoted) {
                    showError("You have already cast your vote for this election.");
                    return;
                }
                
                // Set current user
                currentUser = {
                    email: email,
                    hasVoted: false
                };
                
                console.log("Email authenticated successfully:", email);
                
                // Initialize blockchain connection
                const initialized = await initializeSolana();
                
                // Always show voting section in demo mode
                authSection.classList.add('hidden');
                votingSection.classList.remove('hidden');
            } catch (error) {
                console.error("Failed to authenticate email:", error);
                showError("Failed to authenticate email. Please try again.");
            } finally {
                authBtn.disabled = false;
                authBtn.textContent = 'Authenticate';
            }
        }

        // Check if the user has already voted
        async function checkIfVoted(email) {
            try {
                // In a real app, you would check against your database or blockchain
                // For demo purposes, we'll simulate an API call
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // For demo, we'll assume the user hasn't voted
                return false;
            } catch (error) {
                console.error("Failed to check voting status:", error);
                throw error;
            }
        }

        // Cast vote function
        async function castVote() {
            // Get selected candidate
            const selectedCandidate = document.querySelector('input[name="candidate"]:checked');
            
            if (!selectedCandidate) {
                showError("Please select a candidate to cast your vote.");
                return;
            }
            
            castVoteBtn.disabled = true;
            castVoteBtn.textContent = 'Submitting Vote...';
            
            try {
                const candidateName = selectedCandidate.value;
                
                // Create a Solana transaction
                const transaction = await createVoteTransaction(candidateName);
                
                // For demo purposes, we'll simulate a successful transaction
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Generate a fake transaction ID
                const fakeTransactionId = "5KSm2sHAzAiVpJWWjJZ8UCx4McK6c3MQxtSHsyK9nYBvnNKkYzZCiFYuXFyuD1Z5zGTJQxbKL7LGKzKVCjnnY7dP";
                
                console.log("Vote cast successfully for:", candidateName);
                
                // Mark user as voted
                currentUser.hasVoted = true;
                
                // Show success section
                votingSection.classList.add('hidden');
                successSection.classList.remove('hidden');
                transactionId.textContent = fakeTransactionId;
            } catch (error) {
                console.error("Failed to cast vote:", error);
                showError("Failed to record your vote on the blockchain. Please try again.");
            } finally {
                castVoteBtn.disabled = false;
                castVoteBtn.textContent = 'Cast My Vote';
            }
        }

        // Create a Solana transaction for voting
        async function createVoteTransaction(candidateName) {
            try {
                // In a real app, you would create and sign a real Solana transaction
                // For demo purposes, we'll just log what would happen
                console.log(`Creating transaction to vote for ${candidateName}`);
                
                // This is a simplified example. In a real app:
                // 1. You'd have a program deployed on Solana
                // 2. You'd create a transaction that calls your program
                // 3. You'd sign the transaction with the user's wallet
                // 4. You'd send the transaction to the network
                
                return {
                    candidate: candidateName,
                    voter: currentUser.email,
                    timestamp: new Date().toISOString()
                };
            } catch (error) {
                console.error("Failed to create transaction:", error);
                throw error;
            }
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            authSection.classList.add('hidden');
            votingSection.classList.add('hidden');
            successSection.classList.add('hidden');
            errorSection.classList.remove('hidden');
        }

        // Try again button handler
        function tryAgain() {
            errorSection.classList.add('hidden');
            authSection.classList.remove('hidden');
            emailInput.value = '';
            currentUser = null;
        }

        // Event listeners
        authBtn.addEventListener('click', authenticateEmail);
        castVoteBtn.addEventListener('click', castVote);
        tryAgainBtn.addEventListener('click', tryAgain);

        // Initialize the UI
        function init() {
            // Load all necessary scripts and initialize connections
            console.log("Application initialized");
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
